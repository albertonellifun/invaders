<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, xxxmaximum-scale=1.0, xxxuser-scalable=no"/>
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
	<title>Space Invaders - Apple ][ Clone</title>
	<style>
		body {
			background:#000;
			color:#0f0;
			font-family:monospace;
			text-align:center;
		}
		h1 {
			font-family: monospace;
			font-size: 12px;
		}
		canvas {
			border:3px solid #0f0;
			image-rendering:pixelated;
		}
		#scanlines-overlay {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			pointer-events: none;
			background: repeating-linear-gradient(to right, transparent, transparent 0px, rgba(0, 0, 0, 0.33) 2px, transparent 4px);
			background-size: 100% 4px;
			opacity: 1;
			display:block;
			z-index: 10;
		}
	</style>
</head>
<body>
	<div id="scanlines-overlay"></div>

	<h1>Space Invaders - Apple ][ Clone</h1>
	<canvas id="game" width="600" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const SCALE = 4;
let keys = {};
let frame = 0;
let paused = false;
let scanLinesEnabled = true;
let bw = false;

document.addEventListener("keydown", e => {
  keys[e.key] = true;
  if(e.key.toLowerCase() === "p") { paused = !paused; }
  else if(e.key.toLowerCase() === "r") { resetGame(); }
  else if(e.key.toLowerCase() === "x") { 
	scanLinesEnabled = !scanLinesEnabled; 
	if (scanLinesEnabled) document.getElementById('scanlines-overlay').style.display = 'block';
	else document.getElementById('scanlines-overlay').style.display = 'none';
  }
  else if(e.key.toLowerCase() === "b") { 
	bw = !bw;
	if(bw) document.body.style.filter = 'grayscale(1) contrast(4)';
	else document.body.style.filter = '';
  }
  	
});
document.addEventListener("keyup", e => keys[e.key] = false);


//piccolo: 8x6
const alien1a = ["00111000",
	  "01111100",
	  "11011010",
	  "11111110",
	  "00100100",
	  "01000010"];
const alien1b = ["00111000",
	  "01111100",
	  "11011010",
	  "11111110",
	  "01000010",
	  "00100100"];
//capoccione: 8x6
const alien2a = ["00111100",
	  "01111110",
	  "11011101",
	  "11111111",
	  "01011010",
	  "10100101"];
const alien2b = ["00111100",
	  "01111110",
	  "11011101",
	  "11111111",
	  "10100101",
	  "01011010"];
//triangolo: 8x6
const alien3a = ["00011000",
	  "00111100",
	  "01111110",
	  "11011011",
	  "11111111",
	  "01000010"];
const alien3b = ["00011000",
	  "00111100",
	  "01111110",
	  "11011011",
	  "11111111",
	  "00100100"];
//player: 11x6 
const playerTankSprite = [
      "00000100000",
	  "00001110000",
      "01111111110",
      "11111111111",
      "11111111111",
      "11111111111"
    ];
//bunker: 16x10
const bunkerSprite = [
      "0011111111111100",
      "0111111111111110",
      "1111111111111111",
      "1111111111111111",
      "1111111111111111",
      "1111111111111111",
      "1111111111111111",
      "1111111111111111",
      "1111000000001111",
      "1111000000001111"
    ];
//ufoSprite
const ufoSprite1 = [
    "000111111000",
    "011111111110",
    "111011101111",
    "011111111110"
];
const ufoSprite2 = [
    "000111111000",
    "011111111110",
    "110111011101",
    "011111111110"
];
const ufoSprites = [ ufoSprite1, ufoSprite2 ];

const alienSprites = [
    [alien3a, alien3b],
	[alien2a, alien2b],
	[alien1a, alien1b]    
];

const bombSprite1 = [
	"010",
	"100",
	"010",
	"100"
];
const bombSprite2 = [
	"100",
	"010",
	"100",
	"010"
];
const bombSprite3 = [
	"010",
	"001",
	"010",
	"001"
];
const bombSprite4 = [
	"001",
	"010",
	"001",
	"010"
];
const bombSprites = [bombSprite1, bombSprite2, bombSprite3, bombSprite4];

const bulletSprite = ["010","010","010","010","010","010"];//bullet: 3x6


//disegna in modo quadrettoso [0=pixel spento, 1=pixel acceso]
function drawSprite(sprite, x, y){
  ctx.fillStyle = '#0f0';
  const rows = sprite.length;
  const cols = sprite[0].length;
  const offsetX = (cols * SCALE) / 2;
  const offsetY = (rows * SCALE) / 2;

  for(let r = 0; r < rows; r++) {
    for(let c = 0; c < cols; c++) {
      if(sprite[r][c] === "1") {
        ctx.fillRect(
		  x - offsetX + c * SCALE,//x centrato
          y - offsetY + r * SCALE,//y centrato
          SCALE,
          SCALE
        );
      }
    }
  }
}

//player terrestre incline ad esportare la democrazia nell'universo
class Player {
  constructor(){
    this.x = 280; 
	this.y = 380; 
	this.alive = true; 
	this.bullet = null;
    this.sprite = playerTankSprite;
  }
  update(){
    if(!this.alive) return;
    if(keys["ArrowLeft"]) this.x -= 4;
    if(keys["ArrowRight"]) this.x += 4;
	if(this.x < 30) this.x = 30;
	if(this.x > 570) this.x = 570;
	
    if(keys[" "] && !this.bullet) this.bullet = {x:this.x, y:this.y};
    
	if(this.bullet){
      this.bullet.y -= 6;
	  //disegna bullet
	  drawSprite(bulletSprite, this.bullet.x, this.bullet.y);//bullet:3x6
      if(this.bullet.y < 0) this.bullet = null;
    }
	//disegna cannone
    drawSprite(this.sprite, this.x, this.y);//player: 11x6
  }
}

//alieni cattivi ma stupidi
class Alien {
  constructor(x,y,sprite){
	this.x = x;
	this.y = y;
	this.sprite = sprite;
	this.alive = true;
	this.bombCooldown = Math.random()*200; // timer casuale per sparo
	}
  	
  update(speed){ 
        if(!this.alive) return;
        this.x += speed;
        this.bombCooldown--;
        if(this.bombCooldown <= 0//posso sparare
			&& Math.abs(this.x - player.x) < 10 * SCALE//vedo il PLAYER sotto di me
			&& player.alive//il player non deve essere defunto!
			) {
			//posso sparare solo se sotto non ho altri alieni
			let isFirstRow = true;
			aliens.forEach(a=>{
				if(a.alive && Math.abs(a.x - this.x) < 10 * SCALE && a.y > this.y) {
					isFirstRow = false;
				}
			});
			if (isFirstRow) {
				bombs.push(new Bomb(this.x|0,this.y|0));
				this.bombCooldown = 100 + Math.random()*200;
			}
        }
		//disegna
		drawSprite(this.sprite[Math.floor(frame/20)%2], this.x, this.y);//alieno: 8x6
    }
}

//bunker terrestre
class Bunker {
  constructor(x){
    this.x = x; 
	this.y = 320;
    this.mask = bunkerSprite.map(r=>r.split(""));//array di caratteri, le stringhe sono immutabili
	this.alive = true;
  }
  draw(){
    if(!this.alive) return;
    drawSprite(this.mask,this.x, this.y);
  }

  hit(px, py, radius){
    if(!this.alive) return false;
    let hitSomething = false;

    // offset per centro bunker
    const offsetX = (this.mask[0].length * SCALE) / 2;
    const offsetY = (this.mask.length * SCALE) / 2;

    const cx = Math.floor((px - (this.x - offsetX)) / SCALE);
    const cy = Math.floor((py - (this.y - offsetY)) / SCALE);

    for(let y = -radius; y <= radius; y++){
        for(let x = -radius; x <= radius; x++){
            if(x*x + y*y > radius*radius) continue;
            const bx = cx + x;
            const by = cy + y;
            if(
                by >= 0 && by < this.mask.length &&
                bx >= 0 && bx < this.mask[by].length &&
                this.mask[by][bx] === "1"
            ){
                this.mask[by][bx] = "0";
                hitSomething = true;
            }
        }
    }
    return hitSomething;
  }
}

//bombette aliene
class Bomb {
    constructor(x,y){
        this.x = x; 
		this.y = y;
        this.sprite = bombSprites;
		this.alive = true;
    }
    update(){
	    if(this.y > 400) this.alive = false;
		if(!this.alive) return;
        
		this.y += 3;
        
		//disegna
		drawSprite(this.sprite[Math.floor(frame/5)%4], this.x, this.y);//bomb: 3x4
		
        // collision player 12x6
        if(player.alive && Math.abs(this.x - player.x) <= 6 * SCALE && Math.abs(this.y - player.y)<= 3 * SCALE) {
			doExplode(player.x, player.y, 40);
			player.alive = false;
		}
		
        // collision bunker
        bunkers.forEach(b=>{ 
			if(b.hit(this.x, this.y, 3)) {
				this.alive=false; 
			}
		});
    }
}

//UFO
class UFO {
    constructor(){ 
		this.x = -60; 
		this.y = 15; 
		this.sprite = ufoSprites;
		this.alive = true;
	}
    update(){
		if(!this.alive) return;
        
		this.x += 2;
        
		//collisione bullet 12x4
		if(player.bullet && Math.abs(player.bullet.x - this.x) <= 6 * SCALE && Math.abs(player.bullet.y - this.y) <= 2 * SCALE){
			doExplode(this.x, this.y, 40);
            this.alive = false; 
			player.bullet = null;
        }
		
        if(this.x > 600) this.alive = false;
		
		//disegna
		drawSprite(this.sprite[Math.floor(frame/10)%2], this.x, this.y);//ufo: 12x4
    }
}


//esplosioni
class Particle {
    constructor(x,y,vx,vy,life){
      this.x = x; 
	  this.y = y; 
	  this.vx = vx; 
	  this.vy = vy; 
	  this.life = life;
    }
    update(dt){
      if(this.life <= 0 || this.x <= 0 || this.x >= 600 || this.y <= 0 || this.y >= 400) return;
	  this.x = this.x + this.vx*dt;
      this.y = this.y + this.vy*dt;
      this.life -= dt;
	  //disegna
      ctx.fillRect(this.x - 2, this.y - 2, 4, 4);//particle: 4x4
    }
  }


//kaboom
function doExplode(x,y,qty){
	for(let i=0;i<qty;i++){
		const a = Math.random() * Math.PI*2;
		const sp = Math.random() * 120 + qty;
		const vx = Math.cos(a)*sp;
		const vy = Math.sin(a)*sp;
		const life = qty * Math.random() / 40;
		particles.push(new Particle(x, y, vx, vy, life));
	}
}

//reset
function resetGame() {
    //player
    player.x = 280;
    player.y = 380;
    player.alive = true;
    player.bullet = null;

    //bunker
    bunkers.length = 0; // svuota array
    bunkers.push(new Bunker(150), new Bunker(300), new Bunker(450));

    //alieni
    aliens.length = 0;
    for(let row=0; row<alienRowsCount; row++){
        for(let col=0; col<alienColsCount; col++){
            let ax = 80 + col*44;
            let ay = 40 + row*32;
            aliens.push(new Alien(ax, ay, alienSprites[row % alienSprites.length]));
        }
    }

	//UFO
    ufo = null;
	
    //bombe
    bombs.length = 0;
	
	//particelle
    particles.length = 0;

    //direzione e frame
    dir = 1;
    frame = 0;
}




/* === GAME SETUP === */
const player = new Player();
const bunkers = [];
const aliens = [];
const bombs = [];
const particles = [];//pezzetti di player :-)
let ufo=null;
let dir=1;
let baseSpeed=0.4;
let alienRowsCount = 6;
let alienColsCount = 8;

resetGame();

//LOOOOOOP
let last = performance.now();

function loop(now){
  const dt = Math.min(1/30, (now-last)/1000); 
  last = now;

  if(!paused){
    ctx.clearRect(0,0,600,400);
    const alive = aliens.filter(a=>a.alive).length;
    const speed = baseSpeed + (alienRowsCount*alienColsCount - alive)*0.05;
    let edge=false;

	//alieni
    aliens.forEach(a=>{
      if(!a.alive) return;
      //a.x+=dir*speed;
	  a.update(speed*dir);
      if(a.x<30 || a.x>570) edge=true;
      
      //alieno morto
      if(player.bullet &&
         Math.abs(player.bullet.x - a.x) < 8 * SCALE &&
         Math.abs(player.bullet.y - a.y) < 6 * SCALE
		 ){
			doExplode(a.x, a.y, 10);
			a.alive=false;
			player.bullet=null;
      }
	  
	  //bunker distrutto quando un alieno scende troppo
	  bunkers.forEach(b=>{
		if(b.alive && Math.abs(a.y - b.y) < 10 * SCALE) b.alive = false;// bunker sparisce
	  });
    });
	
	//alieni toccano bordo -> invertire rotta, aumentare velocita :-)
    if(edge){
		dir*=-1; 
		aliens.forEach(a=>a.y+=10);
	}
	
	//player spara al bunker :(
    if(player.bullet) {
		bunkers.forEach(b=>{
			if(player.bullet && b.hit(player.bullet.x,player.bullet.y,1)) {
				player.bullet=null;
			}
		});
	}
	
    //disegno bunker
    bunkers.forEach(b=>b.draw());

    //disegno player
    player.update();
	
	//bombe alieni
    bombs.forEach(b=> b.update());
	for(let i=bombs.length-1;i>=0;i--) if(!bombs[i].alive) bombs.splice(i,1);

    //UFO
    if(!ufo && Math.random()<0.002) ufo = new UFO();
    if(ufo){
		ufo.update();
        if(!ufo.alive) ufo=null;
	}
	
	//particelle
	particles.forEach(p=>p.update(dt));
	
    frame++;
	
	
	let i = 10;
	ctx.font = '10px monospace';
	ctx.fillText('[P]: play/pause  -  [R]: reset  -  [X]: scanlines  -  [B]: bw',5,i);
	
	i+=10;	
	ctx.fillText('player: '+player.x+','+player.y,5,i);
	bunkers.forEach(b => {
		i+=10;
		ctx.fillText('bunker: '+b.x+','+b.y+' alive:'+b.alive,5,i);
	});
		
	if(player.bullet != null) {
		i+=10;
		ctx.fillText('bullet: '+player.bullet.x+', '+player.bullet.y,5,i);
	}
	
	bombs.forEach(b => {
		i+=10;
		ctx.fillText('bomb: '+b.x+','+b.y+' alive:'+b.alive,5,i);
	});
	
	if(ufo) {
		i+=10;
		ctx.fillText('ufo: '+ufo.x+','+ufo.y+' alive:'+ufo.alive,5,i);
	}
	
	}
	
	
	
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>